function addChatLog(e,o){e&&db.run("insert into im_message_"+localStorage.userId+"(id, type, from_id, from_name, to_id, to_name, content,time,flag,user_id,session_id) values(?, ?, ?, ?, ?, ?, ?,?,?,?,?)",[e.id,e.type,e.from_id,e.from_name,e.to_id,e.to_name,e.content,e.time,e.flag,e.user_id,e.session_id],function(e){e?console.log("fail on add "+e):o&&o()})}function updateChatLog(e,o){return e?void db.run("update im_message_"+localStorage.userId+" set id = ?, type = ?, from_id = ?, from_name = ?, to_id = ?, to_name = ?, content = ?, time = ?, flag = ?, user_id = ? ,session_id = ? where id = ?",[e.id,e.type,e.from_id,e.from_name,e.to_id,e.to_name,e.content,e.time,e.flag,e.user_id,session_id],function(e){e?(console.log("fail on updating table "+e),o&&o(e)):o&&o(null)}):void(o&&o("params error"))}function getChatList(e){var o="select (select count(1) from im_message_"+localStorage.userId+" tmp where tmp.session_id = ima.session_id and tmp.flag=0) as count,ima.* from im_message_"+localStorage.userId+" ima where ima.id=(select max(id) from im_message_"+localStorage.userId+" tmp1 group by session_id having tmp1.session_id=ima.session_id) order by id desc";db.all(o,function(o,i){e(i)})}function getSingleChatLog(e,o,i){var s="select * from im_message_"+localStorage.userId+" where id<='"+o+"' AND session_id = '"+e+"' order by id desc limit 0,15 ";db.all(s,function(e,o){o.reverse();try{i(o)}catch(e){console.log(e),alert("catch "+e)}})}function getSessionMaxId(e,o){var i="select max(id) as maxid from im_message_"+localStorage.userId+' where session_id="'+e+'"';db.all(i,function(e,i){o(0!=i[0].maxid?i[0].maxid:999999)})}function getSessionMinId(e,o){var i="select min(id) as minid from im_message_"+localStorage.userId+' where session_id="'+e+'"';db.all(i,function(e,i){o(null!==i?i[0].minid:999999)})}function getGlobalMaxMsgId(e){var o="select max(id) as maxid from im_message_"+localStorage.userId+" where from_id!='"+localStorage.userId+"'";db.all(o,function(o,i){e(null!==i[0].maxid?i[0].maxid:0)})}function changeFlag(e,o){db.run("UPDATE im_message_"+localStorage.userId+" SET flag = 1 WHERE session_id = $session_id",{$session_id:e},function(e){e?console.log("err:"+e):o&&o()})}function getHDImgSrc(e,o){var i="UPDATE * from im_message_"+localStorage.userId+" where session_id = '"+e+"' and content like '[IMG%' order by id asc limit 0,15 ";db.all(i,function(e,o){return e?void console.log(e):o})}function closedb(){db.close()}function setFileDownloaded(e,o,i){console.log(e),console.log(o),db.run("UPDATE im_message_"+localStorage.userId+" SET filepath = '"+o+"' WHERE id = $msgId",{$msgId:e},function(e){e?console.log("err:"+e):i&&i()})}function getFilePath(e,o){var i="select filepath from im_message_"+localStorage.userId+" where id ='"+e+"'";db.all(i,function(e,i){console.log(i),o(null!==i[0].filepath?i[0].filepath:null)})}function delLog(e,o){db.run("delete from im_message_"+localStorage.userId+" where session_id = '"+e+"'",{},function(e){e?console.log("err:"+e):o&&o()})}var sqlite3=require("sqlite3").verbose(),gui=require("nw.gui"),db=new sqlite3.Database("chatlog.db"),userId=localStorage.userId;db.serialize(function(){var e="CREATE TABLE IF NOT EXISTS im_message_"+localStorage.userId+" ( id        INT( 11 )       PRIMARY KEY,type      INT( 11 ),from_id   VARCHAR( 32 ),from_name VARCHAR( 100 ),to_id     VARCHAR( 32 ),to_name   VARCHAR( 100 ),content   TEXT,time      DATETIME,flag      INT( 11 ),user_id   VARCHAR( 255 ),session_id   VARCHAR( 255 ),filepath   VARCHAR( 255 ))";db.run(e)});