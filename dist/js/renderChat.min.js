function renderchat(e,t){localStorage.userId==e.from_id?sendMsgfun(e,t):receivedMsgfun(e,t),getLocal("hasMoreMsgFromRemote","chat-"+e.session_id)&&0===$(".dialogContent"+e.session_id).find(".getMoreLog").length&&$(".dialogContent"+e.session_id).find(".dgbody").prepend('<div  style="text-align:center;padding:6px;color:#1CA5FF;cursor: pointer;"><span class="getMoreLog">加载更多</span></div>')}function sendMsgfun(e,t){var o="";e.content=imgDecode(e.content),e.content=emojiDecode(e.content);var n=fileDecode(e.content,e.id);e.content=n.str;var i=n.done;e.content=voiceDecode(e.content,"send");var s=e.session_id;if(o+='<div id="msgId'+e.id+'" class="sendMsg clearfix"><div class="avatar"><img  draggable="false" src="dist/imgs/index/app/person.png"></div><span class=\'caret-right\'></span><div class="sendMsgCont">'+e.content+"</div></div>",1==t)addTime(e,t),$(".dialogContent"+s).find(".dgbody").append(o).scrollTop(9999999);else{$(".dialogContent"+s).find(".dgbody").prepend(o);var a=$("#msgId"+e.id).outerHeight(),d=$(".dialogContent"+s).find(".dgbody").scrollTop();$(".dialogContent"+s).find(".dgbody").scrollTop(a+d),addTime(e,t)}i&&getFilePath(e.id,function(t){null!==t&&(isNaN(e.id)||($("#msgId"+e.id).find(".downloadBtn").hide(),$("#msgId"+e.id).find(".openFile").show()))})}function addTime(e,t){var o="",n=e.time,i=e.session_id,s=new Date(n).getTime(),a=(new Date).getTime(),d=a-s;if((""==$(".dialogContent"+i).find(".dgbody").html()||d-3e5>=0)&&(d-864e5>0&&d-864e5<0?n=n.substr(-14):d>31536e6||(n=n.substr(-8)),o+='<div id="time'+s+'" class="timestamp"><p>'+n+"</p></div>"),1==t)$(".dialogContent"+i).find(".dgbody").append(o);else{$(".dialogContent"+i).find(".getMoreLog").parent().remove(),$(".dialogContent"+i).find(".dgbody").prepend(o);var r=$("#time"+s).outerHeight(),l=$(".dialogContent"+i).find(".dgbody").scrollTop();$(".dialogContent"+i).find(".dgbody").scrollTop(r+l)}}function receivedMsgfun(e,t){var o=sysInfo(e);if(!o){var n="",i=e.session_id;e.content=imgDecode(e.content),e.content=emojiDecode(e.content);var s=fileDecode(e.content,e.id);e.content=s.str;var a=s.done;if(e.content=posDecode(e.content),e.content=voiceDecode(e.content,"rec"),n+='<div id="msgId'+e.id+'" class="receivedMsg clearfix"><div class="avatar"><img  draggable="false" src="dist/imgs/index/app/person.png"></div>',2==e.type&&(n+='<span style="position:absolute;top:0px;left:70px;">'+e.from_name+"</span>"),n+="<span class='caret-left'></span><div class=\"receivedMsgCont\">"+e.content+"</div></div>",1==t)addTime(e,t),$(".dialogContent"+i).find(".dgbody").append(n).scrollTop(999999999999);else{$(".dialogContent"+i).find(".dgbody").prepend(n);var d=$("#msgId"+e.id).outerHeight(),r=$(".dialogContent"+i).find(".dgbody").scrollTop();$(".dialogContent"+i).find(".dgbody").scrollTop(d+r),addTime(e,t)}a&&getFilePath(e.id,function(t){null!==t&&($("#msgId"+e.id).find(".downloadBtn").hide(),$("#msgId"+e.id).find(".openFile").show())})}}function showChat(e){refreshSessionList(function(){$("#mainContent > div").hide(),$(".dialogContent"+e).show(),$(".main > ul").hide(),$(".dialogList").show(),$(".diaItem").removeClass("active"),$(".diaItem-"+e).addClass("active")})}function renderIframe(e,t){if(0===$(".dialogContent"+e.session_id).length){var o=$(".dialogContent").length,n=$($(".dialogContent")[o-1]).clone();return n.addClass("dialogContent"+e.session_id).attr("id",e.session_id),n.attr("chatType",t),"single"==t&&(n.find(".groupSet").hide(),n.find(".dgTitle").append('<input class="singleClearHistory" value="清除聊天记录" type="button" />')),$("#mainContent").prepend(n),e.session_id==e.to_id?$(".dialogContent"+e.session_id).find(".dialogName").text(e.to_name):$(".dialogContent"+e.session_id).find(".dialogName").text(e.from_name),void showChat(e.session_id)}showChat(e.session_id)}function renderEmptyIframe(e,t){if(0===$(".dialogContent"+e.session_id).length){var o=$(".dialogContent").length,n=$($(".dialogContent")[o-1]).clone();return n.addClass("dialogContent"+e.session_id).attr({id:e.session_id,chatType:t}),"single"==t&&n.find(".groupSet").hide(),$("#mainContent").prepend(n),$(".dialogContent"+e.session_id).find(".dialogName").text(e.session_name),void showChat(e.session_id)}showChat(e.session_id)}function hasMoreMsgFromRemote(e){IM_ajax("/plugins/zatp?cmd=singlehistory",{msgId:999999,rows:20,from:localStorage.userId,to:e},function(e){return!!e.total})}function maxMsgId(e){var t=localStorage.getItem("chat-"+e);if(null!=t)return t=JSON.parse(t),t.maxMsgId;var o={hasMoreMsgFromRemote:!0,maxMsgId:0,minMsgId:999999,historyMsgId:999999};return o=JSON.stringify(o),localStorage.setItem("chat-"+e,o),0}function minMsgId(e){var t=localStorage.getItem("chat-"+e);if(null!=t)return t=JSON.parse(t),t.minMsgId;var o={hasMoreMsgFromRemote:!0,maxMsgId:0,minMsgId:999999,historyMsgId:999999};return o=JSON.stringify(o),localStorage.setItem("chat-"+e,o),999999}function chatInit(e,t,o,n){if(0!==$(".dialogContent"+e).length)return void(n||showChat(e));var i=getLocal("hasMoreMsgFromRemote","chat-"+e)?getLocal("hasMoreMsgFromRemote","chat-"+e):"true",s=maxMsgId(e);"true"==i?0===s?"single"==o?getSessionMaxId(e,function(n){$.ajax({type:"post",url:localStorage.imUrl+"/plugins/zatp?cmd=singlehistory",data:{msgId:999999,rows:15,from:localStorage.userId,to:e},dataType:"json",success:function(n){if(0!==n.rows.length){for(var i="",s=n.rows,a=0;a<s.length;a++){i=s[a].fromId==localStorage.userId?s[a].toId:s[a].fromId;var d={id:s[a].id,to_id:s[a].toId,to_name:s[a].toName,from_id:s[a].fromId,from_name:s[a].fromName,type:1,content:s[a].content,time:s[a].time,flag:0,session_id:i,user_id:localStorage.userId};addChatLog(d)}saveOrSetToLocal("maxMsgId",n.rows[0].id,"chat-"+e),getSessionMinId(e,function(t){saveOrSetToLocal("minMsgId",t,"chat-"+e)}),saveOrSetToLocal("historyMsgId",n.rows[n.rows.length-1].id,"chat-"+e);var r=getLocal("maxMsgId","chat-"+e);getSingleChatLog(e,r,function(e){e.forEach(function(e){renderChatLog(e,o)})})}else n.session_id=e,n.session_name=t,renderChatLog(n,o)},error:function(e){console.log(e)}})}):getSessionMaxId(e,function(n){$.ajax({type:"post",url:localStorage.imUrl+"/plugins/zatp?cmd=grouphistory",data:{msgId:999999999,rows:15,gid:e,userId:localStorage.userId},dataType:"json",success:function(n){if(0!==n.rows.length){for(var i=n.rows,s=0;s<i.length;s++){var a={id:i[s].id,to_id:e,to_name:getLocal("sessionName","chat-"+e),from_id:i[s].fromId,from_name:i[s].fromName,type:2,content:i[s].content,time:i[s].time,flag:0,session_id:e,user_id:localStorage.userId};addChatLog(a)}saveOrSetToLocal("maxMsgId",n.rows[0].id,"chat-"+e),getSessionMinId(e,function(t){saveOrSetToLocal("minMsgId",t,"chat-"+e)}),saveOrSetToLocal("historyMsgId",n.rows[n.rows.length-1].id,"chat-"+e);var d=getLocal("maxMsgId","chat-"+e);getSingleChatLog(e,d,function(e){e.forEach(function(e){renderChatLog(e,o)})})}else n.session_id=e,n.session_name=t,renderChatLog(n,o)},error:function(e){console.log(e)}})}):getSessionMaxId(e,function(n){s=n,getSingleChatLog(e,s,function(n){return 0==n.length?(n.session_id=e,n.session_name=t,n.total=0,void renderChatLog(n,o)):(n.forEach(function(e){renderChatLog(e,o)}),void saveOrSetToLocal("historyMsgId",n[0].id,"chat-"+e))}),showChat(e)}):getSessionMaxId(e,function(t){console.log(o),getSingleChatLog(e,s,function(t){t.forEach(function(e){renderChatLog(e,o)}),saveOrSetToLocal("historyMsgId",t[0].id,"chat-"+e)}),showChat(e)})}function renderChatLog(e,t){return e.hasOwnProperty("total")?void renderEmptyIframe(e,t):(renderIframe(e,t),renderchat(e,1),void $(".dialogContent"+e.session_id).find(".dgbody").scrollTop(9999999))}function recMsg(e){console.log(e);var t;e.c=emojiEncode(e.c),e.c=e.c.replace(/\n/gm,"<br>"),console.log(e),t=1==e.t?{id:e.msgId,to_id:localStorage.userId,to_name:localStorage.userName,from_id:e.id,from_name:e.name,type:e.t,content:e.c,time:e.time,flag:0,session_id:e.id,user_id:localStorage.userId}:{id:e.msgId,to_id:e.gid,to_name:e.gname,from_id:e.id,from_name:e.name,type:e.t,content:e.c,time:e.time,flag:0,session_id:e.gid,user_id:localStorage.userId},2==t.type&&t.from_id==localStorage.userId||addChatLog(t,function(){refreshSessionList(),receivedMsgfun(t,1)})}function IM_ajax(e,t,o){$.ajax({type:"post",url:localStorage.imUrl+e,data:t,dataType:"json",beforeSend:function(e){$(".getMoreLog").text("正在加载...")},success:function(e){o(e)},error:function(e){console.log("err")},complete:function(){$(".getMoreLog").text("加载更多")}})}function getMoreLog(e){var t,o,n=(getLocal("hasMoreMsgFromRemote","chat-"+e),getLocal("maxMsgId","chat-"+e),getLocal("minMsgId","chat-"+e)),i=getLocal("historyMsgId","chat-"+e)-1,s=$(".dialogContent"+e).attr("chattype"),a=$(".dialogContent"+e).find(".dialogName").text();"single"==s?(t="/plugins/zatp?cmd=singlehistory",o={msgId:n,rows:15,from:localStorage.userId,to:e}):(t="/plugins/zatp?cmd=grouphistory",o={msgId:n,rows:15,"gid ":e,"userId ":localStorage.userId}),i<=n?IM_ajax(t,o,function(t){0!==t.rows.length?t.rows.forEach(function(o){o.session_id=e;var n;n="single"==s?{id:o.id,to_id:o.toId,to_name:o.toName,from_id:o.fromId,from_name:o.fromName,type:1,content:o.content,time:o.time,flag:1,session_id:e,user_id:localStorage.userId}:{id:o.id,to_id:e,to_name:a,from_id:o.fromId,from_name:o.fromName,type:2,content:o.content,time:o.time,flag:1,session_id:e,user_id:localStorage.userId},renderchat(n,2),addChatLog(n),saveOrSetToLocal("minMsgId",t.rows[t.rows.length-1].id,"chat-"+e),saveOrSetToLocal("historyMsgId",t.rows[t.rows.length-1].id,"chat-"+e)}):(saveOrSetToLocal("hasMoreMsgFromRemote",!1,"chat-"+e),$(".dialogContent"+e).find(".getMoreLog").parent().remove(),$(".dialogContent"+e).find(".dgbody").prepend('<div  style="text-align:center;padding:6px 0;"><span>无更多消息!</span></div>'))}):getSingleChatLog(e,i,function(t){for(var o=t.reverse(),n=365,i=0,s=o.length;i<s;i++)renderchat(o[i],2),n=o[i].id;saveOrSetToLocal("historyMsgId",n,"chat-"+e)})}function popChat(e){var t,o,n=HTMLDecode(e.c),i=(e.time,e.t);1==i?(t=e.id||"",o=e.name||""):2==i&&(t=e.gid||"",o=e.gname||"");var s=e.no||"",a=require("nw.gui"),d=function(e,t,o,n,i,s){e&&e.match(/^\./)&&(e=e.replace(".","file://"+process.cwd()));var d=new Notification(t,{icon:e,body:o});return d.onclick=function(){a.Window.get().focus(),void 0!==n?(refreshSessionList(),showChat(n),$(".dialogContent"+n).find(".dgbody").scrollTop(999999999999),d.close()):($.ajax({type:"get",url:localStorage.url+"/sms/getUnreadSmsGroup.action",beforeSend:function(e){},success:function(e,t){var o=JSON.parse(e);0===$(".smsBlock").length?($(".smsBlock").remove(),renderSms(o)):($("#mainContent > div").hide(),$(".smsBlock").show()),console.log("获取菜单列表成功！")},complete:function(e,t){},error:function(e){alert("获取数据失败！请检查网络后刷新")}}),d.close())},d.onclose=function(){},d.onshow=function(){},d};50==i?(void 0!==newChat.todo&&newChat.todo.close(),newChat.todo=d("./dist/imgs/index/news.png",n,s,void 0,void 0,"chat"),$("#news_audio")[0].play()):(void 0!==newChat.singChat&&newChat.singChat.close(),1==i?(chatInit(t,o,"single","pop"),changeFlag(t)):(chatInit(t,o,"group","pop"),changeFlag(t)),$(".dialogContent"+t).find(".dgbody").scrollTop(999999999999),0===n.indexOf("[IMG^")&&(n="[图片]"),0===n.indexOf("[FILE^")&&(n="[文件]"),0===n.indexOf("[VOICE^")&&(n="[语音]"),0===n.indexOf("[EMO^")&&(n="[表情]"),0===n.indexOf("[POS^")&&(n="[位置]"),2==i&&e.id==localStorage.userId||(newChat.singChat=d("./dist/imgs/index/msg.png",n,"来自:"+o,t,o,"news"),$("#chat_audio")[0].play()),e.c=emojiDecode(HTMLDecode(e.c)),e.c=e.c.replace(/\n/gm,"<br>"),recMsg(e))}function emojiEncode(e){for(;e.indexOf('<img draggable="false" style="" onclick=""')!=-1;){var t=e.indexOf("<img"),o=e.indexOf(">"),n=e.substring(t,o+1),i=n.match(/EMO_(\S*)\.png/)[1];e=e.replace(n,"[EMO^"+i+"]")}return e}function emojiDecode(e){for(;e.indexOf("[EMO^")!=-1;){var t=e.indexOf("[EMO^"),o=e.indexOf("]"),n=e.substring(t,o+1),i=n.match(/\[EMO\^(\S*)]/)[1];e=e.replace(n,'<img draggable="false" style="" onclick="" src="./dist/imgs/index/emoji/EMO_'+i+'.png"/>')}return e}function HTMLDecode(e){var t=$("<div/>"),o=t.html(e),n=o.text();return output=n,t=null,output}function HTMLEncode(e){var t=document.createElement("div");null!=t.textContent?t.textContent=e:t.innerText=e;var o=t.innerHTML;return t=null,o}function imgDecode(e){if(0===e.indexOf("[IMG^")){var t=e.split("^"),o={url:t[1],thumbUrl:t[2],name:t[3],size:t[4].substring(0,t[4].length)};return'<img  draggable="false" onload="scrollToBottom($(this))" class="thumbImg" style="    vertical-align:middle;" HDUrl="'+o.url+'" title="双击查看原图" src="'+localStorage.imUrl+o.thumbUrl+'" alt="" />'}return e}function scrollToBottom(e){e.closest(".dgbody").scrollTop(1e16)}function voiceDecode(e,t){if(0===e.indexOf("[VOICE^")){var o,n=e.split("^"),i={url:n[1],name:n[2],size:n[3].substring(0,n[3].length-1)};return o="send"==t?'<div class="voice"><img src="dist/imgs/index/voice_send.png" alt=""><span class="voiceDuration">'+i.size+'</span></div><audio hidden class="voicePlay" src="'+localStorage.imUrl+i.url+'"></audio>':'<div class="voice"><span class="voiceDuration">'+i.size+'</span><img src="dist/imgs/index/voice_rec.png" alt=""></div><audio hidden class="voicePlay" src="'+localStorage.imUrl+i.url+'"></audio>'}return e}function fileDecode(e){var t;if(0===e.indexOf("[FILE^")){var o=e.split("^"),n={url:o[1],name:o[2],size:o[3].substring(0,o[3].length-1)},i='<div class=\'fileInfo clearfix\'><img  draggable="false" class="FileImgLogo" src="dist/imgs/index/fileImg.png" alt=""><div style="float:left;"><div title='+n.name+" class='fileName'>"+n.name+"</div><div class='fileSize'>"+n.size+"</div><div class='downloadFile' size='"+n.size+"' path='"+n.url+"' name='"+n.name+"'>";i+="<span style='margin-right:5px;' class='receiveFile downloadBtn'>接收</span><span class='downloadBtn'><span  class='saveasFile '>另存为</span><input class='nwsaveas' hidden type='file' name='file' nwsaveas/></span><span style='cursor:pointer;display:none;' class='openFile'>打开文件</span>",i+="</div></div></div><div hidden style='width:100%;height:3px;border:1px solid #aaa;border-radius:2px;text-align:left;' class='downloadProcess'><div style='display:block;background-color:#0f0;height:3px;' class='downloading'></div></div>",t={str:i,done:!0}}else t={str:e,done:!1};return t}function posDecode(e){if(0===e.indexOf("[POS^")){var t=e.split("^"),o={posInfo:t[1],position:t[2]},n='<div class="posHead"><div class="posInfo">'+o.posInfo+'</div></div><div class="posBody"><img pos="'+o.position+'" class="posImg" draggable="false" src="http://api.map.baidu.com/staticimage?width=300&height=300px&center='+o.position+"&markers="+o.position+'&zoom=15" alt=""></div>';return n}return e}function upload(e,t,o,n,i){function s(e){var t=e.loaded,n=e.total,i=Math.floor(100*t/n);$("#msgId"+o).find(".sendMsgCont").find(".uploadProcess").css("width",i+"%")}var a,d,r,l;switch(t){case"img":a="dialogContent"+e,d="imgForm";break;case"file":a="dialogContent"+e,d="fileForm";break;case"audio":a="dialogContent"+e,d="audioForm"}n?(l=n,r=l._size,r=fileSizeConvert(r)):(l=new FormData($("."+a).find("."+d)[0]),r=$("."+a).find("."+d).find("input")[0].files[0].size,r=fileSizeConvert(r)),uploadxhr=$.ajax({url:localStorage.imUrl+"/plugins/zatp?cmd=upload",type:"POST",cache:!1,dataType:"json",data:l,processData:!1,contentType:!1,xhr:function(){var t=$.ajaxSettings.xhr();if(s&&t.upload){var n={id:o,session_id:e,content:"<div class='uploadProcessBox' style='width:230px;height:20px;text-align:center;'><span class='uploadProcess' style='display:block;height:100%;width:1%;background-color:#1CA5FF;'></span><span class='processShow' style='display:block;margin-top:-20px;'></span>发送中...</div>"};return sendMsgfun(n,1),t.upload.addEventListener("progress",s,!1),t}}}).done(function(n){var s,a=n.oName||"",d=n.url||"",l=n.thumbUrl||"",c=$(".dialogContent"+e),g=e,f=c.find(".dialogName").text(),u=Object.keys(n).length;3==u?s="vocie"==t?"[VOICE^"+d+"^"+a+"^"+r+"]":"[FILE^"+d+"^"+a+"^"+r+"]":4==u&&(s="[IMG^"+d+"^"+l+"^"+a+"^"+r+"]");var m,h,p=s,v=$(".dialogContent"+e).attr("chatType");"single"==v?(m="/plugins/zatp?cmd=sendsinglemsg",h={content:p,from:localStorage.userId,to:g}):(m="/plugins/zatp?cmd=sendgroupmsg",h={content:p,from:localStorage.userId,gid:g}),IM_ajax(m,h,function(a){if(a.status){var d=(a.info,(new Date).format("yyyy-MM-dd hh:mm:ss")),r={id:a.info,to_id:g,to_name:f,from_id:localStorage.userId,from_name:localStorage.userName,type:1,content:s,time:d,flag:1,session_id:g,user_id:localStorage.userId};addChatLog(r,function(){var d;if($("#msgId"+o).remove(),3==u)"vocie"==t||(d={id:a.info,session_id:e,content:s},setFileDownloaded(a.info,i,function(){function e(){sendMsgfun(d,1)}setTimeout(e,500)}));else if(4==u){var r='<img  draggable="false" class="thumbImg" src="'+localStorage.imUrl+n.thumbUrl+'" alt="" />';d={id:a.info,session_id:e,content:r},sendMsgfun(d,1),$("#msgId"+a.info).find(".thumbImg").attr("HDUrl",n.url)}})}})}).fail(function(t,n,i){console.log("上传失败!");var s="<div style='text-align:center;margin-bottom:15px;'><span style='padding:2px 15px;border-radius:20px;background-color:rgba(0,0,0,0.2);color:#555;'>发送失败!</span></div>";$("#msgId"+o).remove(),$(".dialogContent"+e).find(".dgbody").append(s)})}function fileSizeConvert(e){if(e<1024)return e+"B";if(e<1048576){var t=e/1024;return t.toFixed(2)+"KB"}if(e<1073741824){var t=e/1024/1024;return t.toFixed(2)+"MB"}if(e<1099511627776){var t=e/1024/1024/1024;return t.toFixed(2)+"GB"}}function fileSizeToBite(e){var t,o=parseInt(e);return e.indexOf("K")!=-1&&(t=1024*o),e.indexOf("M")!=-1&&(t=1024*o*1024),e.indexOf("G")!=-1&&(t=1024*o*1024*1024),t}function makeCenter(e,t){void 0===t&&(t=window);var o=$("."+e).width(),n=$("."+e).height(),i=$(t).width(),s=$(t).height();$("."+e).css({top:(s-n)/2-20+"px",left:(i-o)/2+"px"})}function convertBase64ToImg(e){var t=(new Date).format("yyyyMMddhhmmss"),o="./shortCut/shortCut_"+t+".jpeg",n=new Buffer(e,"base64");return fs.writeFile(o,n,function(e){e?console.log(e):console.log("写入成功！")}),o}function delFile(e){fs.unlink(e,function(e){return e?console.error(e):void console.log("文件删除成功！")})}function sumitImageFile(e,t,o,n){var i=new FormData,s=convertBase64UrlToBlob(e).size;i.append("imageName",convertBase64UrlToBlob(e),n),i._size=s;try{upload(t,o,n.substring(0,n.length-4),i)}catch(e){console.log(e)}}function convertBase64UrlToBlob(e){for(var t=window.atob(e.split(",")[1]),o=new ArrayBuffer(t.length),n=new Uint8Array(o),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new Blob([o],{type:"image/jpeg"})}function downloadFile(e,t,o,n,i){function s(e){a.exists(e,function(n){if(n){var g=o.split("."),f=g[0],u=g[1],m=process.cwd()+"\\downloadfile\\"+f+" ("+c+")."+u;return c++,s(m)}c=1,r(d(localStorage.imUrl+t),{}).on("progress",function(e){var t=fileSizeToBite(i),o=e.size.transferred/t*1e3;o=Math.floor(o)/10,o>=100&&(o=100),$("#"+l).find(".downloadProcess").show().find(".downloading").css("width",o+"%")}).on("error",function(e){console.log(e)}).on("end",function(){$("#"+l).find(".downloading").css("width","100%"),$("#"+l).find(".downloadProcess").hide(),$("#"+l).find(".downloadBtn").hide(),$("#"+l).find(".openFile").show();var t=parseInt(l.replace(/[^0-9]/gi,""));setFileDownloaded(t,e)}).pipe(a.createWriteStream(e))})}var a=require("fs"),d=require("request"),r=require("request-progress"),l=n.closest(".receivedMsg ").attr("id")||n.closest(".sendMsg ").attr("id");s(e);var c=1}function sysInfo(e){if("IM_SYSTEM"==e.from_id){var t="<div style='text-align:center;margin-bottom:15px;'><span style='padding:2px 15px;border-radius:20px;background-color:rgba(0,0,0,0.2);color:#555;'>"+e.content+"!</span></div>";return $(".dialogContent"+e.session_id).find(".dgbody").append(t),!0}return!1}function isExistGroup(e){IM_ajax("/plugins/zatp?cmd=roomexists",{gid:e,user:localStorage.userId},function(t){return!!t.status||(delLog(e),refreshSessionList(),$(".dialogContent"+e).remove(),void 0)})}function delHtmlTag(e){return e.replace(/<[^>]+>/g,"")}var gui=require("nw.gui"),fs=require("fs");Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"S+":this.getTime().toString().substr(-3)};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var o in t)new RegExp("("+o+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[o]:("00"+t[o]).substr((""+t[o]).length)));return e},Array.prototype.forEach||(Array.prototype.forEach=function(e){var t=this.length;if("function"!=typeof e)throw new TypeError;for(var o=arguments[1],n=0;n<t;n++)n in this&&e.call(o,this[n],n,this)}),$("body").on("click",".dialogContent .dgfooter .dgBtn",function(){var e=$(this),t=$(this).closest(".dialogContent").attr("id"),o=$(this).closest(".dialogContent").find(".dialogName").text(),n=$(this).closest(".dialogContent").find(".textInput")[0].innerHTML;$(this).closest(".dialogContent").find(".textInput")[0].innerHTML="";var i=HTMLDecode(emojiEncode(n)),s=$(this).closest(".dialogContent").attr("chatType");"single"==s?IM_ajax("/plugins/zatp?cmd=sendsinglemsg",{content:i,from:localStorage.userId,to:t},function(e){if(e.status){var i=(e.info,(new Date).format("yyyy-MM-dd hh:mm:ss")),s={id:e.info,to_id:t,to_name:o,from_id:localStorage.userId,from_name:localStorage.userName,type:1,content:n,time:i,flag:1,session_id:t,user_id:localStorage.userId};s.content=emojiEncode(s.content),s.content=HTMLDecode(s.content),s.content=s.content.replace(/\n/gm,"<br>"),addChatLog(s,function(){console.log(s),sendMsgfun(s,1),refreshSessionList()})}}):IM_ajax("/plugins/zatp?cmd=sendgroupmsg",{content:i,from:localStorage.userId,gid:t},function(i){if(console.log(i),i.status){var s=(i.info,(new Date).format("yyyy-MM-dd hh:mm:ss")),a={id:i.info,to_id:t,to_name:o,from_id:localStorage.userId,from_name:localStorage.userName,type:2,content:n,time:s,flag:1,session_id:t,user_id:localStorage.userId};a.content=emojiEncode(a.content),a.content=HTMLDecode(a.content),a.content=a.content.replace(/\n/gm,"<br>"),console.log(a),addChatLog(a,function(){e.closest(".dialogContent").find(".textInput")[0].innerHTML="",sendMsgfun(a,1),refreshSessionList()})}})}),$("body").on("keydown",".textInput",function(e){if(13==e.keyCode){if(""==$(this)[0].innerHTML)return alert("发送的消息不能为空！"),void($(this).closest(".dialogContent").find(".textInput")[0].innerHTML="");if(e.shiftKey)return;e.preventDefault(),e.cancelBubble=!0,e.stopPropagation();var t=$(this).closest(".dialogContent").attr("id");$(".dialogContent"+t+" .dgfooter .dgBtn").click(),e.preventDefault()}}),$("body").on("click",".chats li",function(){var e=$(this).attr("id"),t=$(this).find(".diaName").text(),o=$(this).attr("chatType");chatInit(e,t,o),changeFlag(e)}),$("body").on("click",".getMoreLog",function(){var e=$(this).closest(".dialogContent").attr("id");getMoreLog(e)});var newChat={},newTodo={};$("body").on("click",".emoji",function(e){$(this).qqFace({id:"facebox",assign:"textInput",path:"./dist/imgs/index/emoji/"}),e.stopPropagation()}),$("body").click(function(){$(".facebox").hide()}),$("body").on("click",".voice",function(){$(this).next(".voicePlay")[0].play()}),$("body").on("dblclick",".posImg",function(){var e=$(this).attr("pos");gui.Window.open("./openMap.html?position="+e,{},function(e){e.maximize()})});var uploadxhr;$("body").on("dblclick",".thumbImg",function(){var e=$(this).attr("HDUrl"),t=($(this).closest(".dialogContent").attr("id"),gui.Window.get(window.open(localStorage.imUrl+e,{position:"center",width:960,height:600,focus:!0,frame:!0})));t.maximize()}),$("body").on("click",".closeHDImg",function(){$(".HDImgBox").hide()}),$(".abort").click(function(e){uploadxhr.abort()}),$("body").on("click",".abort",function(){uploadxhr.abort()});var url_base64;$("body").on("paste",".textInput",function(e){var t,o=nw.Clipboard.get();if(url_base64=o.get("jpeg")){o.set("");var n=$(this).closest(".dialogContent").attr("id"),i=(new Date).format("yyyyMMddhhmmssS"),s="shortCut_"+i+".jpg";$(".shortCutSending").attr({pid:n,date:i,name:s}),$(".shortCutSending").find(".shortCutImg").attr("src",url_base64),$(".body_mask").show(),$(".shortCutSending").show()}else if(t=o.get("text"),o.set(""),t)return void $(this).append(t)}),$(".shortCutSendingClose,.shortCutSending .btnCancel").click(function(e){$(".shortCutSending").hide(),$(".body_mask").hide()}),$(".shortCutSending .btnConfirm").click(function(e){var t=$(".shortCutSending").attr("pid"),o=($(".shortCutSending").attr("date"),$(".shortCutSending").attr("name"));sumitImageFile(url_base64,t,"img",o),$(".shortCutSending").hide(),$(".body_mask").hide();var n=nw.Clipboard.get();n.clear()}),$("body").on("click",".shortCutSendingClose,.shortCutSendingFooter btnCancel",function(){$(".shortCutSending").hide()}),$("\tbody").on("click",".saveasFile",function(){var e=$(this).closest(".downloadFile").attr("name");$(this).next("input").attr("nwsaveas",e).click()}),$("body").on("click",".receiveFile",function(){var e=$(this).closest(".downloadFile").attr("path"),t=$(this).closest(".downloadFile").attr("name"),o=$(this).closest(".downloadFile").attr("size"),n=$(this).closest(".receivedMsg ").attr("id")||$(this).closest(".sendMsg ").attr("id"),i=process.cwd()+"\\"+t,s=$(this);downloadFile(i,e,t,s,o,n)}),$("body").on("change",".nwsaveas",function(){var e=$(this).val(),t=$(this).closest(".downloadFile").attr("path"),o=$(this).closest(".downloadFile").attr("name"),n=$(this).closest(".downloadFile").attr("size"),i=$(this);downloadFile(e,t,o,i,n)}),$("body").on("click",".openFile",function(){var e=$(this).closest(".receivedMsg").attr("id")||$(this).closest(".sendMsg").attr("id"),t=parseInt(e.replace(/[^0-9]/gi,""));getFilePath(t,function(e){if(e)try{gui.Shell.openItem(e)}catch(e){console.log(e)}else console.log("打开文件失败！")})});