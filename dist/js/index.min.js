function adaptWin(){var t=$(window).height(),e=t-$(".ctBlcok").offset().top-60;$(".ctList_fixed>div").css("height",e+"px")}function keybind(){function t(t){IM_ajax("/plugins/zatp?cmd=getroominfo",{gid:t},function(e){$(".dialogContent"+t).find(".memberList").find(".memberItem").remove();var n=e.info.members,o='<li uid="'+e.info.admin.uid+'" class="memberItem "><div class="avatar"><img draggable="false"  src="dist/imgs/index/contact/person.png" alt=""></div><p class="name">'+e.info.admin.name+"</p></li>";$(".dialogContent"+t).find(".memberList").append(o),console.log(n),n.forEach(function(e){console.log(e);var n=e.uid,o=e.name,i='<li uid="'+n+'" class="memberItem "><div class="avatar"><img draggable="false"  src="dist/imgs/index/contact/person.png" alt=""></div><p title="'+o+'" class="name">'+o+"</p></li>";$(".dialogContent"+t).find(".memberList").append(i)}),e.info.admin.uid==localStorage.userId?($(".dialogContent"+t).find(".delGroup").find("input").val("解散当前群"),$(".dialogContent"+t).find(".delGroup").attr("type","dismiss")):($(".dialogContent"+t).find(".delGroup").find("input").val("退出当前群"),$(".dialogContent"+t).find(".delGroup").attr("type","quit")),$(".dialogContent"+t).find(".groupNameContent").text(e.info.name)})}function e(t){if(IM_ajax("/plugins/zatp?cmd=leaveroom",{gid:t,user:localStorage.userId},function(e){delLog(t,function(){})}),delLog(t),refreshSessionList(),$(".dialogContent"+t).remove(),$(".chats").find(".diaItem").length){var e=$(".chats").find(".diaItem").eq(0).attr("id");showChat(e)}else $("#mainContent").find(".smsBlock").show()}function n(t){if(IM_ajax("/plugins/zatp?cmd=delroom",{gid:t},function(e){delLog(t,function(){})}),delLog(t),refreshSessionList(),$(".dialogContent"+t).remove(),$(".chats").find(".diaItem").length){var e=$(".chats").find(".diaItem").eq(0).attr("id");showChat(e)}else $("#mainContent").find(".smsBlock").show()}$("._").click(function(){index_win.minimize()}),$(".maxWin").click(function(){$(this).hasClass("maxed")?(index_win.unmaximize(),$(this).removeClass("maxed")):(index_win.maximize(),$(this).addClass("maxed"))}),$(".x").click(function(){$(".quit").show(),$(".body_mask").show()});var o;$(".search").keyup(function(t){function e(){n=$(".search").val(),i=encodeURI(n);var t=localStorage.url+"/system/core/base/quicksearch/search_result_2.jsp?keyword="+i;$(".searchBlock").find("iframe").attr("src",t)}if(""==$(".search").val())return void $(".searchBlock").hide();$(".searchBlock").show();var n,i;clearTimeout(o),o=setTimeout(e,500)}),$("body").click(function(t){t.target!=$(".search")[0]&&$(".searchBlock").hide()}),$("body").on("mouseover",".smsTabBlock p,.moreSmsItem",function(){$(this).css("color","#0296f8")}),$("body").on("mouseout",".smsTabBlock p,.moreSmsItem",function(){$(this).css("color","#888")}),$("body").on("click",".moreSmsClass",function(){$(".moreSms").stop().slideToggle(200)}),$("body").on("mouseleave",".moreSms",function(){$(".moreSms").stop().slideUp(200)}),$(".set").click(function(t){$(".setList").toggle(),$(".addList").hide(),t.stopPropagation()}),$("body").click(function(t){$(".setList").hide(),$(".personInfo").hide()}),$(".add").click(function(t){$(".addList").toggle(),$(".setList").hide(),t.stopPropagation()}),$("body").click(function(t){$(".addList").hide()}),$("body").on("click",".diaItem",function(){$(".diaItem").removeClass("active"),$(this).addClass("active");var t=$(this).attr("chattype"),e=$(this).attr("id");"group"==t&&isExistGroup(e)}),$("body").on("click",".closeDgSet",function(){$(this).closest(".dialogContent").find(".dgSetContent").animate({right:"-80%"},500,function(){})}),$("body").on("click",".groupSet",function(){$(this).closest(".dialogContent").find(".dgSetContent").animate({right:"0"},500,function(){});var e=$(this).closest(".dialogContent").attr("id");t(e)}),$("body").on("click",".singleClearHistory",function(){var t=$(this).closest(".dialogContent").attr("id");alertBox("确实要删除聊天记录吗？删除后不可恢复！",function(){IM_ajax("/plugins/zatp?cmd=clearsinglemsg",{sessionId:t,user:localStorage.userId},function(e){try{delLog(t),$(".dialogContent"+t).find(".dgbody").empty(),console.log("单聊记录删除成功！")}catch(t){console.log(t)}})})}),$("body").on("click",".dialogContent .delGroup input",function(){var t=$(this).parent().attr("type"),o=$(this).closest(".dialogContent").attr("id"),i=$(this).closest(".dialogContent").find(".dialogName").text();"dismiss"==t?alertBox("您确定要解散 "+i+" 群吗？",function(){n(o)}):alertBox("您确定要退出 "+i+" 群吗？",function(){e(o)})}),$("body").on("click",".head",function(){0!==$(this).siblings(".body").find("li").length&&($(this).hasClass("open")?($(this).find(".caret-set").addClass("caret-right").removeClass("caret-down"),$(this).siblings(".body").slideUp(200),$(this).removeClass("open")):($(this).parent().hasClass("contactItem")&&($(this).parent().parent().find(".caret-set").removeClass("caret-down").addClass("caret-right"),$(this).parent().parent().find(".body").slideUp(200),$(this).parent().parent().find(".head").removeClass("open")),$(this).find(".caret-set").removeClass("caret-right").addClass("caret-down"),setTimeout("adaptWin()",200),$(this).siblings(".body").slideDown(200),$(this).addClass("open")))}),$("body").on("click",".abc li",function(){for(var t,e,n=$(this).text(),o=0,i=0,s=$(".personList").length;i<s;i++){if(e=$($(".personList")[i]).outerHeight(),n==$($(".personList")[i]).find(".personOrder").text()){t=$($(".personList")[i]).index(),$(".scrollContent").stop().animate({scrollTop:o},500,function(){});break}o+=Number(e)}}),$("body").on("click",".ctBlcok .head",function(){addContact()}),$("body").on("click",".appList li",function(){var t,e=$(this).attr("menucode");t=menucode.indexOf("http")!=-1?e:localStorage.url+e,""!==e&&null!==e&&void 0!==e&&($(".appItemList li").css("background-color","#fff"),$(this).css("background-color","#eaf2ff"),nw.Window.open(t,{},function(t){t.maximize()}))}),$("body").on("click",".orgItem .avatar",function(t){$this=$(this);var e=$(this).position(),n=$(window).height(),o=n-58-50,i=e.top+380,s=e.top-380;i<o?$(".personInfo").css({top:e.top+62+"px",left:e.left+28+"px"}):s>0?$(".personInfo").css({top:e.top+62-380+"px",left:e.left+28+"px"}):(makeCenter("personInfo",".dialogContent"),$(".personInfo").css({left:e.left+28+"px"})),$.ajax({url:localStorage.url+"/personManager/getPsersonInfoByUserId.action",type:"post",data:{userId:$this.siblings().attr("userid")},dataType:"json",success:function(t){t.rtState&&(t.rtData.userName.length>5?$(".personInfo").find(".personName").text(t.rtData.userName.substr(0,5)+"..."):$(".personInfo").find(".personName").text(t.rtData.userName),$(".personInfo").find(".personNameDetail").text(t.rtData.userName),$(".personInfo").find(".personPos").text(t.rtData.deptIdName),"0"==t.rtData.sex?$(".personInfo").find(".personSex").text("男"):$(".personInfo").find(".personSex").text("女"),$(".personInfo").find(".posName").text(t.rtData.userRoleStrName),$(".personInfo").find(".tele").text(t.rtData.mobilNo),$(".personInfo").find(".personEmail").text(t.rtData.email))},error:function(t){console.log("err on personInfo :"+t)}}),$(".personInfo").show(),t.stopPropagation()}),$("body").on("click",".closePerInfo",function(){$(".personInfo").hide()}),$("body").on("click",".personInfo",function(t){t.stopPropagation()}),$(".setting").click(function(){$(".setBlock").show()}),$(".setContentList li").click(function(){$(".setContentList li").removeClass("setActive"),$(this).addClass("setActive");var t=$(this).index();$(".setBlock .right .setContent").hide(),$(".setBlock .right .setContent").eq(t).show()}),$(".setClose").click(function(){$(".setBlock").hide()}),"true"==localStorage.autoLogin?$(".autoLoginBtn").prop("checked",!0):$(".autoLoginBtn").prop("checked",!1),$("body").on("click",".multi-switch",function(){var t=$(".autoLoginBtn").prop("checked");localStorage.autoLogin=t}),$(".messageBtn").click(function(){$(".main>ul").hide(),$(".dialogList").show()}),$(".emailBtn").click(function(){nw.Window.open(localStorage.url+"/system/core/email/index.jsp",{},function(t){t.maximize()})}),$(".newBtn").click(function(t){nw.Window.open(localStorage.url+"/system/core/base/news/person/queryNotLookList.jsp",{},function(t){t.maximize()})}),$(".noticeBtn").click(function(t){nw.Window.open(localStorage.url+"/system/core/base/notify/person/index.jsp",{},function(t){t.maximize()})}),$(".todoBtn").click(function(){nw.Window.open(localStorage.url+"/system/core/workflow/flowrun/list/index.jsp",{},function(t){t.maximize()})}),$(".contactBtn").click(function(){$(".main>ul").hide(),$(".contactList").show(),showAllgroup()}),$(".appCenter").click(function(){""==$(".appList").text()&&getMenu(),$(".main>ul").hide(),$(".appList").show()}),$("body").on("click",".sign",function(){nw.Window.open(localStorage.url+"/system/core/base/attend/duty/index.jsp",{},function(t){t.maximize()})}),$("body").on("click",".orgList .sendEmail",function(){var t=$(this).parent().siblings(".left").find(".orgname").attr("id");nw.Window.open(localStorage.url+"/system/core/email/send.jsp?toUsers="+t,{},function(t){t.maximize()})}),$("body").on("mousedown",".audio",function(){$(this).closest(".dialogContent").find(".toSendAudio").show()}),$("body").on("mouseup",".audio",function(){$(this).closest(".dialogContent").find(".toSendAudio").hide(),$("body").mouseup(function(){$(".toSendAudio").hide()})}),$(".toLogout").click(function(){$(".logout").show(),$(".body_mask").show()}),$(".quitApp").click(function(t){$(".quit").show(),$(".body_mask").show()}),$(".logoutClose").click(function(){$(".logout").hide(),$(".body_mask").hide()}),$(".logoutFooter .btnCancel").click(function(){$(".logout").hide(),$(".body_mask").hide()}),$(".logout .btnConfirm").click(function(){gui.Window.get(nw.Window.open("./login.html",{min_width:960,min_height:600,frame:!1},function(t){index_win.close(),closedb()}));localStorage.removeItem("cookie")}),$(".quit .btnConfirm").click(function(){console.log(gui),gui.App.closeAllWindows(),closedb()}),$(".quitClose").click(function(){$(".quit").hide()}),$(".quitFooter .btnCancel").click(function(){$(".quit").hide(),$(".body_mask").hide()}),$(".creatSinglrChat").click(function(t){$(".main>ul").hide(),$(".contactList").show(),$(".org").click()}),$("body").on("click",".toContact",function(){$(".contactBtn").click(),$(".contactItem").find(".head").click()}),$("body").on("click",".sendItem",function(){$(this).hasClass("sendImg")?$(this).closest(".dialogContent").find(".imgForm").find("input").click():$(this).hasClass("sendFile")?$(this).closest(".dialogContent").find(".fileForm").find("input").click():$(this).hasClass("sendVoice")||$(this).hasClass("shortCut")&&gui.Shell.openItem(process.cwd()+"/shortCutTool/ScreenCapture.exe")}),$("body").on("change",".formDate input",function(){var t=$(this).closest(".dialogContent").attr("id"),e=$(this).val().split("\\").pop().length-4,n=$(this).val().split("\\").pop().substring(0,e),o=$(this).val();$(this).parent().hasClass("imgForm")?upload(t,"img",n):$(this).parent().hasClass("fileForm")?upload(t,"file",n,void 0,o):$(this).parent().hasClass("voiceForm")&&upload(t,"voice",n),$(this).val("")})}function menuColor(){var t="";$(".menuItem img,.sendToolbar li>img").on("mouseenter",function(e){var n=$(this).attr("src");t=n;var o=n.replace(".png","_sel.png");$(this).attr("src",o)}).mouseout(function(e){$(this).attr("src",t)})}function getMenu(){$.ajax({type:"get",url:localStorage.url+"/teeMenuGroup/getPrivSysMenu.action",beforeSend:function(t){},success:function(t,e){var n=JSON.parse(t);renderMenu(n),console.log("获取菜单列表成功！")},complete:function(t,e){},error:function(t){alert("获取数据失败！请检查网络后刷新")}})}function renderMenu(t){for(var e="",n="",o="",i=0,s=t.rtData.length;i<s;i++)if(3==t.rtData[i].menuId.length)e='<li class="appItem appItem-'+t.rtData[i].menuId+' clearfix" menuCode='+t.rtData[i].menuCode+">",e+='<div class="head clearfix"><div class="icon"><img  draggable="false" src="'+localStorage.url+"/system/frame/3/icons/"+t.rtData[i].icon+'" alt=""></div><p class="title">'+t.rtData[i].menuName+'</p><span class="caret-right caret-set"></span><span class="border"></span></div><div class="body"><ul class="appItemList"></ul></div>',e+="</li>",$("ul.appList").append(e);else if(6==t.rtData[i].menuId.length){var a=t.rtData[i].menuId.substring(0,3);n='<li class="appItem-1 appItem-'+t.rtData[i].menuId+'" menuCode="'+t.rtData[i].menuCode+'" ><span style="width:10px;height:10px;border-radius:50%;display:inline-block;background-color:#1CA5FF;margin-left:24px;margin-top:12px;"></span><p class="itemName">'+t.rtData[i].menuName+"</p></li>",$(".appItem-"+a).find(".appItemList").append(n)}else{var a=t.rtData[i].menuId.substring(0,6);o='<li class="appItem-2" menuCode="'+t.rtData[i].menuCode+'" ><p class="itemName">'+t.rtData[i].menuName+"</p></li>",$(".appItem-"+a).after(o)}}function getOrg(t,e){var n=e||function(){};void 0==t?(t=0,url=localStorage.url+"/mobileOrgController/getSelectUserTree.action"):url=localStorage.url+"//mobileOrgController/getSelectUserTree.action?id="+t;var o=$(".orgStructure .orgList-"+t).find("li").length;0===o?$.ajax({type:"get",url:url,beforeSend:function(t){},success:function(e,o){var i=JSON.parse(e);renderOrg(i,t),n(),console.log("获取组织结构文件成功！")},complete:function(t,e){},error:function(t){alert("获取数据失败！请检查网络后刷新")}}):n()}function renderOrg(t,e){var n=$(".orgStructure .orgList-"+e).find("li").length,o=$(".orgStructure .orgList-"+e).parents(".orgList").length;if(0===t.rtData.length){var i=["<li style='padding:10px 0;text-align:center;'>暂无人员！</li>"];return void $(".orgStructure .orgList-"+e).append(i.join(""))}if(0===n)for(var s=0,a=t.rtData.length;s<a;s++){var i=[],r=10*o;r=10*o,"dept"===t.rtData[s].type?(i.push('<li class="orgItem orgItem-'+o+'" style="padding-left:'+r+'px;box-sizing:border-box;">'),i.push('<p class="orgTitle">'),i.push('<span class="caret-right"></span>'),i.push(t.rtData[s].name),i.push("</p>"),i.push('<ul class="orgList orgList-'+t.rtData[s].id+'">'),i.push("</ul>"),i.push("</li>"),$(".orgStructure .orgList-"+e).append(i.join(""))):(i.push('<li class="clearfix" style="padding-left:'+r+'px;box-sizing:border-box;">'),i.push('<div class="left fl">'),i.push('<div class="avatar">'),i.push('<img  draggable="false" src="dist/imgs/index/contact/person.png" alt="">'),i.push("</div>"),i.push('<div userId="'+t.rtData[s].userId+'" id="'+t.rtData[s].id+'" pid="'+t.rtData[s].pid+'" class="orgname">'+t.rtData[s].name+"</div>"),i.push("</div>"),i.push('<div class="right fr">'),i.push('<span class="oper sendMessage"><img  draggable="false" src="dist/imgs/index/contact/toMessage.png"></span>'),i.push('<span class="oper sendEmail"><img  draggable="false" src="dist/imgs/index/contact/toEmail.png"></span>'),i.push("</div>"),i.push("</li>"),$(".orgStructure .orgList-"+e).append(i.join("")))}}function getSmsNumber(){function t(t){for(var e in t.rtData)$(".badge-"+e).text(t.rtData[e]),0==t.rtData[e]?$(".badge-"+e).hide():$(".badge-"+e).show(),t.rtData[e].length>=3&&($(".badge-"+e).css({width:"30px","border-radius":"50%",right:"0px"}),$(".badge-"+e).text("99+")),t.rtData.SMS_TOTAL.length>=3&&$(".badge-SMS_TOTAL").css({width:"30px","border-radius":"50%",right:"0px","margin-right":"-8px"})}$.ajax({type:"post",dataType:"json",url:localStorage.url+"/mobileSystemAction/getNewPush.action",beforeSend:function(t){},success:function(e,n){e.rtState&&t(e),console.log("更新成功！")},complete:function(t,e){},error:function(t){alert("获取数据失败！请检查网络后刷新")}})}function addContact(){function t(t){for(var e=0,n=t.length;e<n;e++){var o=[];o.push('<ul class="personList personList-'+t[e].title+'">'),o.push('<span class="personOrder">'+t[e].title+"</span>");for(var i=0,s=t[e].datas.length;i<s;i++)o.push('<li class="personItem '+t[e].datas[i].sid+'">'),o.push('<div class="avatar">'),o.push('<img  draggable="false" src="dist/imgs/index/app/person.png">'),o.push("</div>"),o.push('<span class="personItemName">'+t[e].datas[i].name+"</span>"),o.push("</li>");o.push("</ul>"),$(".scrollContent").append(o.join(""))}}var e=localStorage.url+"/teeAddressController/getAddressFullNamListByMobile.action";$.ajax({type:"post",url:e,success:function(e){var n=JSON.parse(e);n.rtState?t(n.rtData):alert("获取通讯录失败！请重试！")}})}function showAllgroup(){IM_ajax("/plugins/zatp?cmd=getrooms",{user:localStorage.userId},function(t){if($(".group").find(".groupItem").remove(),0==t.length){var e='<p style="padding:10px 0;width:100%;text-align:center;">无群组</p>';$(".group").find(".body").append(e)}else{var n=[];t.forEach(function(t){n.push('<li gid="'+t.gid+'" class="groupItem">'),n.push('<div class="avatar">'),n.push('<img draggable="false" src="dist/imgs/index/avatar_demo.png">'),n.push("</div>"),n.push('<span class="groupName">'+t.name+"</span>"),n.push("</li>")});var e=n.join("");$(".group").find(".body").append(e)}})}function alertBox(t,e,n){$(".alertBox .alertBoxbody").find("p").text(t),$(".alertBox").find(".btnConfirm").one("click",function(){e(),$(".alertBox").hide(),$(".body_mask").hide()}),$(".alertBox").find(".btnCancel").one("click",function(){(n=n||function(){$(".alertBox").hide(),$(".body_mask").hide()})()}),$(".body_mask").show(),$(".alertBox").show(),$(".alertBoxClose").one("click",function(){$(".body_mask").hide(),$(".alertBox").hide()})}$(function(){document.title=localStorage.title,keybind(),menuColor(),makeCenter("setBlock"),makeCenter("logout"),makeCenter("quit"),makeCenter("upgrade"),makeCenter("contactBlock",".contactDetail"),makeCenter("creatGpChat"),makeCenter("shortCutSending"),makeCenter("alertBox"),getSmsNumber(),$(window).resize(function(t){makeCenter("setBlock"),makeCenter("logout"),makeCenter("quit"),makeCenter("upgrade"),makeCenter("shortCutSending"),makeCenter("alertBox"),makeCenter("HDImgBox"),makeCenter("contactBlock",".contactDetail"),adaptWin();var e=$(window).height(),n=e-236;$(".group").find(".body").css({height:n+"px","overflow-x":"hidden","overflow-y":"auto"})}),$(".logoBlock .name").text(localStorage.title),refreshSessionList(),getOfflineMessages(function(){refreshSessionList(function(){$(".allNews").click(),$(".transaction").addClass("active")})}),$("body").on("click",".sendMessage",function(){var t=$(this).parent().siblings(".left").find(".orgname").attr("userId"),e=$(this).parent().siblings(".left").find(".orgname").attr("id"),n=$(this).parent().siblings(".left").find(".orgname").text();chatInit(t,n,"single",e)})});var gui,win,index_win=null;"undefined"!=typeof require&&(gui=require("nw.gui"),index_win=gui.Window.get());var tray1=new gui.Tray({title:"系统托盘",icon:"appIcon.png"});tray1.tooltip="PC协同办公";var menu1=new gui.Menu,menu_item=new gui.MenuItem({label:"关闭程序",click:function(){tray=null,menu=null,index_win.close(),tray.remove()}});menu1.append(menu_item),tray1.menu=menu1,$("body").on("mouseover",".orgList>.clearfix",function(){$(this).css("background-color","#e9f2ff"),$(this).find(".right").show()}).on("mouseleave",".orgList>.clearfix",function(){$(this).css("background-color","#fff"),$(this).find(".right").hide()}),$("body").on("click",".orgStructure .orgTitle",function(){var t=$(this),e=t.siblings(".orgList").attr("class"),n=e.split(" "),o=n[1].substring(8);getOrg(Number(o),function(){0!==t.siblings(".orgList").find("li").length&&(t.hasClass("open")?(t.find("span").addClass("caret-right").removeClass("caret-down"),t.siblings(".orgList").slideUp(),t.removeClass("open")):(t.find("span").addClass("caret-down").removeClass("caret-right"),t.siblings(".orgList").slideDown(),t.addClass("open")))})}),$("body").on("click",".org",function(){getOrg(),$(".orgStructure").siblings().hide(),$(".orgStructure").show()}),$(".menuItem").click(function(t){getSmsNumber()}),$("body").on("click",".clearbtn",function(){var t=$(this).closest(".dialogContent").attr("id");alertBox("确定要清除历史消息吗？清除后不可恢复！",function(){IM_ajax("/plugins/zatp?cmd=cleargroupmsg",{session_id:t,user:localStorage.userId},function(t){console.log(t)});try{delLog(t),$(".dialogContent"+t).find(".dgbody").empty()}catch(t){console.log(t)}})}),$(".group").find(".head").click(function(t){var e=$(window).height(),n=e-236;$(".group").find(".body").css({height:n+"px","overflow-x":"hidden","overflow-y":"auto"}),showAllgroup()}),$(".group").find(".body").on("click","li",function(){var t=$(this).attr("id"),e=$(this).find(".groupName").text();chatInit(t,e,"group")}),$(".clearCacaheBtn").click(function(t){alertBox("清除缓存后需要重新登录,是否继续？",function(){localStorage.clear();gui.Window.get(nw.Window.open("./login.html",{min_width:960,min_height:600,frame:!1},function(t){index_win.close(),closedb()}))})});