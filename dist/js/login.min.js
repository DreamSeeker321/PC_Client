function makeCenter(e,t){void 0===t&&(t=window);var n=$("."+e).width(),i=$("."+e).height(),o=$(t).width(),r=$(t).height();$("."+e).css({top:(r-i)/2-20+"px",left:(o-n)/2+"px"})}function bindkey(){$(".switch").click(function(){$(".section1").hasClass("open")?($(".section1").removeClass("open").hide(),$(".section2").addClass("open").show(),$(".situPassword").show(),$(".situCode").hide()):($(".section2").removeClass("open").hide(),$(".section1").addClass("open").show(),$(".situCode").show(),$(".situPassword").hide())}),$("._").click(function(){win.minimize()}),$(".maxWin").click(function(){win.maximize()}),$(".x").click(function(){win.close()}),$(".upgradeClose").click(function(){$(".upgrade").hide()}),$(".upgradeFooter .btnCancel").click(function(){$(".upgrade").hide(),new_win=gui.Window.get(nw.Window.open("./index.html",{min_width:960,min_height:600,frame:!1},function(e){tray.remove(),tray=null,menu=null,win.close()}))}),$(".upgrade .btnConfirm").click(function(){$("#updatingAppBack").show(),$("#processbar_out").show(),downloadAPP()}),$("#login").click(function(){toLogin(1)}),$("body").on("keyup","#username,#password",function(e){13==e.keyCode&&toLogin(1)}),$(".selectMenu").click(function(e){$(".selectNet").hide(),$(".netContent").show(),$(".netGroup").show(),e.stopPropagation()}),$(".netContent").click(function(e){$(".netContent").hide(),$(".netGroup").hide()}),$("body").click(function(e){$(".selectNet").show(),$(".netContent").hide(),$(".netGroup").hide()}),$(".netGroup li").click(function(e){if("空"!=$(this).text()){var t=$(this).text(),n=$(this).index()+1;$(".selectNet .selectMenu").text(t.substr(0,5)+"..."),$(".selectNet .selectMenu").attr("selectedIp","net"+n);var i=localStorage.getItem("net"),o=$(".selectNet .selectMenu").attr("selectedIp");i=JSON.parse(i);var r,a,c,p;""!==i.IM.ip&&""!==i.IM.port?(p=removeHttp(i.IM.ip),p.indexOf(":")!==-1?(a=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+p.substring(0,p.indexOf(":")+1):"http://"+p.substring(0,p.indexOf(":")+1),c=i.IM.port):(a=i.IM.ip,c=i.IM.port),c=i.IM.port):(""!=i.IM.ip&&""==i.IM.port&&(p=removeHttp(i.IM.ip),p.indexOf(":")!==-1?(a=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+p.substring(0,p.indexOf(":")+1):"http://"+p.substring(0,p.indexOf(":")+1),c=p.substring(p.indexOf(":")+1)):(a=i.IM.ip,c=$(".checkboxDiv .left2").find("input").prop("checked")?":9091":":9090")),""==i.IM.ip&&""!=i.IM.port&&(p=removeHttp(i[o].ip),p.indexOf(":")!=-1?(a=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+p.substring(0,p.indexOf(":")+1):"http://"+p.substring(0,p.indexOf(":")+1),c=i.IM.port):(a=i[o].ip,c=i.IM.port)),""==i.IM.ip&&""==i.IM.port&&(p=removeHttp(i[o].ip),p.indexOf(":")!=-1?$(".checkboxDiv .left2").find("input").prop("checked")?(a="https://"+p.substring(0,p.indexOf(":")+1),c="9091"):(a="http://"+p.substring(0,p.indexOf(":")+1),c="9090"):(a=i[o].ip,c=$(".checkboxDiv .left2").find("input").prop("checked")?":9091":":9090"))),r=a+c,localStorage.setItem("imUrl",r),lastLogin={netId:o,name:i[o].name,ip:i[o].ip},lastLogin=JSON.stringify(lastLogin),localStorage.setItem("lastLogin",lastLogin);var l=i[o].ip;localStorage.url=l,$("#refreshImg").click()}else alert("请选择有效的地址或在输入设置界面填入新地址!")}),"true"==localStorage.autoLogin?($("#autoLogin").prop("checked",!0),$("#remPassword").prop("checked",!0)):$("#autoLogin").prop("checked",!1),$("#autoLogin").click(function(e){var t=$(this).prop("checked");localStorage.autoLogin=t,t&&$("#remPassword").prop("checked","true")});var e=localStorage.isRemenber;localStorage.isRemenber;"true"==e?$("#remPassword").prop("checked",!0):$("#remPassword").removeAttr("checked"),$(".netSet").click(function(){$(".netSetBlock").slideDown()}),$(".closeSet").click(function(){$(".netSetBlock").slideUp()}),$(".loginByPsd").click(function(e){$(".section2").removeClass("open").hide(),$(".section1").addClass("open").show(),$(".situCode").show(),$(".situPassword").hide()})}function toLogin(e,t){var n=$("#username").val(),i=$("#password").val(),o=$("#remPassword").prop("checked"),r=$("#autoLogin").prop("checked"),a=localStorage.getItem("net"),c=$(".selectNet .selectMenu").attr("selectedIp");if(void 0==c)return void alert("请选择网址！");a=JSON.parse(a),lastLogin={netId:c,name:a[c].name,ip:a[c].ip},lastLogin=JSON.stringify(lastLogin),localStorage.setItem("lastLogin",lastLogin);var p=a[c].ip;localStorage.url=p;var l=localStorage.url;if(1==e)var s={userName:n,pwd:i};else var s={userName:t.id,pwdCrypt:t.pwd};null!=l?$.post(l+"/mobileSystemAction/doLoginIn.action",s,function(e,t,n){var a=JSON.parse(e);if(a.rtState){localStorage.userId=a.rtData.userId,localStorage.userName=a.rtData.userName,o?(localStorage.password=i,localStorage.isRemenber=o):(localStorage.removeItem("password"),localStorage.isRemenber=!1),r?localStorage.autoLogin=!0:localStorage.autoLogin=!1,localStorage.title=a.rtData.appTitle,localStorage.imPic=a.rtData.imPic;var c=checkVersion(a.rtData.currVersion4PC);if(c)return;new_win=gui.Window.get(nw.Window.open("./index.html",{min_width:960,min_height:600,frame:!1},function(e){tray.remove(),tray=null,menu=null,win.close()}))}else alert("您输入的用户名或密码错误!")}):alert("请选择登录地址")}function remPassword(){$("#remPassword").prop("checked");localStorage.isRemenber&&($("#username").val(localStorage.userId),$("#password").val(localStorage.password)),$("#username").val(localStorage.userId)}function autoLogin(){var e=localStorage.autoLogin;"true"==e&&($("#username").val(localStorage.userId),$("#password").val(localStorage.password),toLogin(1))}function loadSet(){var e=localStorage.net1_name,t=localStorage.net2_name,n=localStorage.net3_name,i=localStorage.net4_name;""!=e&&void 0!=e&&$("ip1").text(e),""!=t&&void 0!=t&&$("ip2").text(t),""!=n&&void 0!=n&&$("ip3").text(n),""!=i&&void 0!=i&&$("ip4").text(i)}function regIp(e){var t="",n=e.replace(/：/g,":");return $(".checkboxDiv .left2").find("input").prop("checked")?n.indexOf("http://")==-1&&n.indexOf("https://")==-1?t="https://"+n:n.indexOf("http://")!=-1&&(t=n.replace(/http/,"https")):t=n.indexOf("http://")==-1&&n.indexOf("https://")==-1?"http://"+n:n.indexOf("https://")!=-1?n.replace(/https/,"http"):n,t}function removeHttp(e){if(e.indexOf("https://")!=-1){var t=e.replace("https://","");return t}var t=e.replace("http://","");return t}function loadNet(){var e=localStorage.getItem("net");if(null!=e){e=JSON.parse(e);for(var t=1;t<4;t++)null!=e["net"+t].name&&null!=e["net"+t].ip&&($(".netSelect"+t).find(".net").find("input").val(e["net"+t].name),$(".netSelect"+t).find(".IpAddr").find("input").val(e["net"+t].ip));$(".port .im1 .left2").find("input").val(e.IM.ip),$(".port .im2 .left2").find("input").val(e.IM.port),$(".checkboxDiv .left2").find("input").prop("checked",e.IM.check)}if($(".setConfirm input").click(),null!=localStorage.lastLogin){var n=localStorage.getItem("lastLogin");n=JSON.parse(n);var i=n.name;$(".selectMenu").text(i),$(".selectMenu").attr("selectedIp",n.netId)}}function GUID(){this.date=new Date,"function"!=typeof this.newGUID&&(GUID.prototype.newGUID=function(){this.date=new Date;var e="";sexadecimalDate=this.hexadecimal(this.getGUIDDate(),16),sexadecimalTime=this.hexadecimal(this.getGUIDTime(),16);for(var t=0;t<9;t++)e+=Math.floor(16*Math.random()).toString(16);for(e+=sexadecimalDate,e+=sexadecimalTime;e.length<32;)e+=Math.floor(16*Math.random()).toString(16);return this.formatGUID(e)},GUID.prototype.getGUIDDate=function(){return this.date.getFullYear()+this.addZero(this.date.getMonth()+1)+this.addZero(this.date.getDay())},GUID.prototype.getGUIDTime=function(){return this.addZero(this.date.getHours())+this.addZero(this.date.getMinutes())+this.addZero(this.date.getSeconds())+this.addZero(parseInt(this.date.getMilliseconds()/10))},GUID.prototype.addZero=function(e){return"NaN"!=Number(e).toString()&&e>=0&&e<10?"0"+Math.floor(e):e.toString()},GUID.prototype.hexadecimal=function(e,t,n){return void 0!=n?parseInt(e.toString(),n).toString(t):parseInt(e.toString()).toString(t)},GUID.prototype.formatGUID=function(e){var t=e.slice(0,8)+"-",n=e.slice(8,12)+"-",i=e.slice(12,16)+"-",o=e.slice(16,20)+"-",r=e.slice(20);return t+n+i+o+r})}function loginByImg(){""!=localStorage.url&&$.ajax({type:"post",url:localStorage.url+"/systemAction/qrCodeLoginCheck.action",data:{guid:newCode},dataType:"json",success:function(e){if(e.rtState){var t=e.rtData.userId,n=e.rtData.pwdCrypt,i={id:t,pwd:n};toLogin(2,i)}},error:function(e){console.log(e)}})}function IM_ajax(e,t,n){$.ajax({type:"post",url:localStorage.imUrl+e,data:t,dataType:"json",success:function(e){n&&n(e)},error:function(){alert("err2")}})}function imgErr(){console.log("扫码登录地址错误或不可用！"),$("#codeImg").attr("src").indexOf("undefined")==-1&&alert("请检查网络地址是否可用!")}function checkVersion(e){var t="20170228";if(t<e)return $(".upgrade").show(),!0}function loadLogoImg(){var e=localStorage.getItem("imPic");void 0!==e&&"undefined"!=e&&""!==e&&null!==e&&($(".logoImg").attr("src",e+".png"),downloadLogoImg(e))}function fsExistsSync(e){var t=require("fs");try{t.accessSync(e)}catch(e){return!1}return!0}function downloadLogoImg(e){var t=require("fs"),n=require("request"),i=require("request-progress"),o=fsExistsSync(process.cwd()+"/"+e+".png");return o?void $(".logoImg").attr("src","./"+localStorage.imPic+".png"):void i(n(localStorage.url+"/imAttachment/downFile.action?id="+e+"&vt="+(new Date).getTime()),{}).on("progress",function(e){}).on("error",function(e){}).on("end",function(){$(".logoImg").attr("src",localStorage.imPic+".png")}).pipe(t.createWriteStream(localStorage.imPic+".png"))}function downloadAPP(){var e=require("fs"),t=require("request"),n=require("request-progress");n(t(localStorage.url+"/appupdate/im/PC_Update.exe"),{}).on("progress",function(e){var t=e.size.transferred/e.size.total*1e3;t=Math.floor(t)/10,$("#currentProcess").text(t+"%"),$("#processbar_in").css("width",t+"%")}).on("error",function(e){}).on("end",function(){$("#currentProcess").text("100%"),$("#processbar_in").css("width","100%"),$("#process_title").text("下载完成,正在解压..."),gui.Shell.openItem(process.cwd()+"/PC_Update.exe"),gui.App.quit()}).pipe(e.createWriteStream("PC_Update.exe"))}$(function(){makeCenter("loginContent"),makeCenter("netSetBlock"),makeCenter("processbar_out"),makeCenter("upgrade"),loadLogoImg(),bindkey(),remPassword(),$(window).resize(function(e){makeCenter("loginContent"),makeCenter("netSetBlock"),makeCenter("processbar_out"),makeCenter("upgrade")}),loadNet(),autoLogin(),$("#refreshImg").click(),setInterval(loginByImg,3e3)});var newImg,newCode,net={},lastLogin={},gui,win,index_win=null;"undefined"!=typeof require&&(gui=require("nw.gui"),win=gui.Window.get());var tray=new gui.Tray({title:"系统托盘",icon:"appIcon.png"});tray.tooltip="OA办公系统";var menu=new gui.Menu;menu.append(new gui.MenuItem({label:"关闭程序",click:function(){tray.remove(),tray=null,menu=null,win.close()}})),tray.menu=menu,$("#refreshImg").click(function(e){newImg=new GUID,newCode=newImg.newGUID(),$("#codeImg").attr("src",localStorage.url+"/systemAction/qrCodeLoginImage.action?guid="+newCode)}),$(".setConfirm input").click(function(){var e=$(".netSelect1 .net").find("input").val(),t=$(".netSelect1 .IpAddr").find("input").val();if(""!=e&&""!=t){var n=regIp(t),i=removeHttp(n);$(".netSelect1 .IpAddr").find("input").val(i),$(".ip1").text(e)}else $(".ip1").text("空");var o=$(".netSelect2 .net").find("input").val(),r=$(".netSelect2 .IpAddr").find("input").val();if(""!=o&&""!=r){var a=regIp(r),c=removeHttp(a);$(".netSelect2 .IpAddr").find("input").val(c),$(".ip2").text(o)}else $(".ip2").text("空");var p=$(".netSelect3 .net").find("input").val(),l=$(".netSelect3 .IpAddr").find("input").val();if(""!=p&&""!=l){var s=regIp(l),d=removeHttp(reged_i3);$(".netSelect3 .IpAddr").find("input").val(d),$(".ip3").text(p)}else $(".ip3").text("空");var u=$(".netSelect4 .net").find("input").val(),g=$(".netSelect4 .IpAddr").find("input").val();if(""!=u&&""!=g){var f=regIp(g),h=removeHttp(f);$(".netSelect4 .IpAddr").find("input").val(h),$(".ip4").text(u)}else $(".ip4").text("空");var m=$(".port .im1 .left2").find("input").val(),I=$(".port .im2 .left2").find("input").val(),v=$(".checkboxDiv .ssl_checkbox .left2").find("input").prop("checked");net={net1:{name:e,ip:n},net2:{name:o,ip:a},net3:{name:p,ip:s},net4:{name:u,ip:f},IM:{ip:m,port:I,check:v}};var w=JSON.stringify(net);localStorage.setItem("net",w),$(".netSetBlock").slideUp();var S=$(".selectMenu").attr("selectedip");if(void 0!=S){var x,k,M,b;""!==net.IM.ip&&""!==net.IM.port?(b=removeHttp(net.IM.ip),b.indexOf(":")!==-1?(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+b.substring(0,b.indexOf(":")+1):"http://"+b.substring(0,b.indexOf(":")+1),M=net.IM.port):(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+net.IM.ip:"http://"+net.IM.ip,M=net.IM.port),M=net.IM.port):(""!=net.IM.ip&&""==net.IM.port&&(b=removeHttp(net.IM.ip),b.indexOf(":")!==-1?(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+b.substring(0,b.indexOf(":")+1):"http://"+b.substring(0,b.indexOf(":")+1),M=b.substring(b.indexOf(":")+1)):(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+net.IM.ip:"http://"+net.IM.ip,M=":9090")),""==net.IM.ip&&""!=net.IM.port&&(b=removeHttp(net[S].ip),b.indexOf(":")!=-1?(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+b.substring(0,b.indexOf(":")+1):"http://"+b.substring(0,b.indexOf(":")+1),M=net.IM.port):(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+net.IM.ip:"http://"+net.IM.ip,M=net.IM.port)),""==net.IM.ip&&""==net.IM.port&&(b=removeHttp(net[S].ip),b.indexOf(":")!=-1?(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+b.substring(0,b.indexOf(":")+1):"http://"+b.substring(0,b.indexOf(":")+1),M="9090"):(k=$(".checkboxDiv .left2").find("input").prop("checked")?"https://"+net.IM.ip:"http://"+net.IM.ip,M=":9090"))),x=k+M,localStorage.setItem("imUrl",x)}}),newImg=new GUID,newCode=newImg.newGUID();