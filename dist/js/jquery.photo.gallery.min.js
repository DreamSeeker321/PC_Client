!function(t){var e=8;t.fn.extend({photoGallery:function(i){function n(t){var e=parseInt(t.wheelDelta||-t.detail);e>0?s():c()}function o(){a(),t(v.imgs).each(function(e,i){t(v.template.IMAGE).appendTo(b).attr("src",i.url).attr("index",e).css({width:i.imgWidth,height:i.imgHeight,left:(C-i.imgWidth)/2,top:(M-i.imgHeight)/2}).on("dblclick",function(){app.window.close()})}),y=t(".image[index='"+v.activeIndex+"']",b).addClass("active")}function a(){w=v.imgs[v.activeIndex].imgWidth,I=v.imgs[v.activeIndex].imgHeight,H=w/I,C=document.body.clientWidth,M=document.body.clientHeight,t(".image",b).removeClass("active"),y=t(".image[index='"+v.activeIndex+"']",b).addClass("active").css({width:w,height:I}).removeClass("rotate0 rotate90 rotate180 rotate270"),x=N.find("img").attr("src",v.imgs[v.activeIndex].url),N.find("img").removeAttr("class").removeAttr("style"),k=!1,N.hide(),Y.removeClass("active"),J.removeClass("active"),u()}function s(){var t=y.width(),e=y.height(),i=t*v.ratio,n=e*v.ratio;i-t<1&&(i=Math.ceil(i));var o=(i/w*100).toFixed(0);o>90&&o<110?(o=100,i=w,n=I):o>1600&&(o=1600,i=16*w,n=16*I),y.width(i).height(n),u(),r(o),l(i,n)}function c(){var t,e,i=y.width(),n=y.height(),o=(i/v.ratio/w*100).toFixed(0);o<5?(o=5,t=w/20,e=I/20):o>90&&o<110?(o=100,t=w,e=I):(t=i/v.ratio,e=n/v.ratio),y.width(t).height(e),u(),r(o),l(t,e)}function l(t,e){k&&(t=[e,e=t][0]),t>document.body.clientWidth||e>document.body.clientHeight?(N.show(),m()):N.hide()}function d(t){var i=document.body.clientHeight-e,n=document.body.clientWidth-e;"90"!=t&&"270"!=t||(n=[i,i=n][0]);var o,a;o=Math.min(w,n),a=Math.min(I,i),o/a>H?o=a*H:a=o/H,y.css({width:o,height:a}),u()}function h(t){var e=v.thumbnailsWidth,i=v.thumbnailsHeight;"90"!=t&&"270"!=t||(e=[i,i=e][0]),x.css({maxWidth:e,maxHeight:i}),N.hide()}function r(e){b.find(".percentTip").remove(),t("<div class='percentTip'><span>"+e+"%</span></div>").appendTo(b).fadeOut(1500)}function u(){var t=y.width(),e=y.height(),i=document.body.clientWidth,n=document.body.clientHeight,o=(i-t)/2,a=(n-e)/2;y.css("left",o+"px").css("top",a+"px")}function m(){var t,e,i,n,o=N.find("img"),a=o.width(),s=o.height(),c=y.width(),l=y.height(),d=y.offset(),h=d.left,r=d.top,u=document.body.clientWidth,m=document.body.clientHeight;k&&(a=[s,s=a][0],c=[l,l=c][0]),t=a/(c/u),c<u&&(t=a),e=s/(l/m),l<m&&(e=s),i=(v.thumbnailsWidth-a)/2+-h/c*a,c<u&&(i=(v.thumbnailsWidth-a)/2),n=(v.thumbnailsHeight-s)/2+-r/l*s,l<m&&(n=(v.thumbnailsHeight-s)/2),N.find(".thumbDrag").css({width:t,height:e,left:i,top:n})}var g=navigator.userAgent.indexOf("Firefox")>-1,p=g?"DOMMouseScroll":"mousewheel",f={ratio:1.2,thumbnailsWidth:180,thumbnailsHeight:120,template:{OPERTATION:'<div class="oper"><span class="prev"><i class="icon_tool-prev"></i></span><span class="next"><i class="icon_tool-next"></i></span></div><div class="tool"><div class="toolct"><span class="oper_fullscreen" title="查看全屏"><i class="icon_tool-fullscreen"></i></span><span class="oper_bigger" title="放大图片"><i class="icon_tool-bigger"></i></span><span class="oper_smaller" title="缩小图片"><i class="icon_tool-smaller"></i></span><span class="oper_rotate" title="向右旋转"><i class="icon_tool-rotate"></i></span><span class="oper_download" title="下载图片"><i class="icon_tool-download"></i></span></div></div>',THUMBNAILS:'<div class=\'thumbnails\'><span class="thumbClose" title="关闭缩略图"><i class="icon_close-small"></i></span><img ondragstart="return false;"/><div class="thumbDrag"><span></span></div></div>',IMAGE:'<img class="image" ondragstart="return false;"/>'}},v=t.extend(f,i),b=t(this);b.append(v.template.OPERTATION).append(v.template.THUMBNAILS);var y,x,w,I,H,W,_,C,M,k,A,G,S=t(this).find(".tool"),T=t(this).find(".oper_fullscreen"),E=t(this).find(".oper_bigger"),O=t(this).find(".oper_smaller"),D=t(this).find(".oper_rotate"),X=t(this).find(".oper_download"),Y=t(this).find(".prev"),J=t(this).find(".next"),N=t(this).find(".thumbnails");Y.on("click",function(){v.activeIndex>0&&v.activeIndex--,a()}).on("mouseover",function(e){v.activeIndex>0&&t(this).addClass("active")}).on("mouseout",function(e){t(this).removeClass("active")}),J.on("click",function(){v.activeIndex<v.imgs.length-1&&v.activeIndex++,a()}).on("mouseover",function(e){v.activeIndex<v.imgs.length-1&&t(this).addClass("active")}).on("mouseout",function(e){t(this).removeClass("active")}),N.css({height:v.thumbnailsHeight,width:v.thumbnailsWidth}).on("mouseenter",function(t){A=-1}).on("mousedown",function(t){A=t.pageX||t.clientX,G=t.pageY||t.clientY,C=document.body.clientWidth,M=document.body.clientHeight,t.stopPropagation()}).on("mousemove",function(e){if(A>0){var i,n,o,a,s=e.pageX||e.clientX,c=e.pageY||e.clientY,l=t(this).find(".thumbDrag"),d=y.width(),h=y.height(),r=x.width(),u=x.height(),m=parseFloat(l.css("left"))+(s-A),g=parseFloat(l.css("top"))+(c-G),p=l.width(),f=l.height();k&&(r=[u,u=r][0],d=[h,h=d][0]),i=(v.thumbnailsHeight-u)/2,n=(v.thumbnailsWidth-r)/2,o=v.thumbnailsWidth-p-n-2,a=v.thumbnailsHeight-f-i-2,m<n?m=n:m>o&&(m=o),g<i?g=i:g>a&&(g=a),l.css({left:m,top:g}),A=s,G=c,m=d<C?(C-d)/2:-d*(m-n)/r,g=h<M?(M-h)/2:-h*(g-i)/u,y.offset({left:m,top:g})}}).on("mouseup",function(t){A=-1}),N.find(".thumbClose").on("click",function(){N.hide()}),b.on("mouseover",function(t){S.show()}).on("mouseenter",function(t){W=-1}).on("mouseout",function(t){S.hide()}).on("mousedown",function(t){W=t.pageX||t.clientX,_=t.pageY||t.clientY,C=document.body.clientWidth,M=document.body.clientHeight,t.stopPropagation()}).on("mousemove",function(t){if(W>0){var e=t.pageX||t.clientX,i=t.pageY||t.clientY,n=y.offset(),o=n.left+(e-W),a=n.top+(i-_),s=y.width(),c=y.height();k&&(s=[c,c=s][0]),s>C?o>0?o=0:o<C-s&&(o=C-s):o=n.left,c>M?a>0?a=0:a<M-c&&(a=M-c):a=n.top,y.offset({left:o,top:a}),W=e,_=i,m()}}).on("mouseup",function(t){W=-1});var F,P,B,L,j;return T.on("click",function(){var e=window.parent.document,i=t(e.getElementById("J_pg"));F?(F=!1,i.css({top:L,left:j,width:P,height:B})):(F=!0,P=document.body.clientWidth,B=document.body.clientHeight,L=i.css("top"),j=i.css("left"),i.css({top:0,left:0,width:e.body.clientWidth,height:e.body.clientHeight}))}),E.on("click",function(){s()}),O.on("click",function(){c()}),D.on("click",function(){var t=y.attr("class").match(/(rotate)(\d*)/);if(t){var e=(1*t[2]+90)%360;y.removeClass(t[0]).addClass("rotate"+e),x.removeClass(t[0]).addClass("rotate"+e),d(e),h(e),k=90==e||270==e}else y.addClass("rotate90"),x.addClass("rotate90"),d("90"),h("90"),k=!0}),X.on("click",function(){var t=y.attr("src");t&&alert("没有找到兼容所有浏览器方法，所以暂不实现")}),t(window).on("resize",function(){u()}),document.attachEvent?document.attachEvent("on"+p,function(t){n(t)}):document.addEventListener&&document.addEventListener(p,function(t){n(t)},!1),document.onkeydown=function(t){t=t||window.event,t.keyCode&&(37==t.keyCode&&(v.activeIndex>0&&v.activeIndex--,a()),39==t.keyCode&&(v.activeIndex<v.imgs.length-1&&v.activeIndex++,a()))},o(),this}}),t.extend({openPhotoGallery:function(i){var n=t(i),o=n[0].src;if(o){var a,s,c=n[0],l=c.naturalHeight,d=c.naturalWidth,h=d/l,r=415,u=615,m=document.body.clientHeight-2*e,g=document.body.clientWidth-e;s=Math.max(u,d),a=Math.max(r,l),s>g&&(s=g,a=Math.max(r,Math.ceil(s/h)),d>s&&(d=s,l=Math.ceil(d/h))),a>m&&(a=m,s=Math.max(u,Math.ceil(a*h)),l>a&&(l=a,d=Math.ceil(l*h)));var p=t(i).closest(".gallerys"),f=0,v=[];p.find(".gallery-pic").each(function(e,i){var n=this.src,c=t(this)[0],h=c.naturalHeight,r=c.naturalWidth,u=r/h,m=r,g=h;n==o?(f=e,m=d,g=l):(r>s&&(m=s,h=g=Math.ceil(m/u),g>a&&(h=g=a,m=Math.ceil(g*u))),h>a&&(g=a,m=Math.ceil(g*u),m>s&&(m=s,g=Math.ceil(m/u)))),v.push({url:n,imgHeight:g,imgWidth:m})}),localStorage.photoGalleryImgs=JSON.stringify(v),localStorage.photoGalleryActiveIndex=f,t("#J_pg").remove(),t("<iframe></iframe").appendTo("body").attr("id","J_pg").attr("src","jquery-photo-gallery/gallery.html").css({position:"absolute",left:(document.body.clientWidth-s)/2,top:(document.body.clientHeight-a)/2,width:s,height:a,background:"rgba(177, 178, 179, 0.6)",border:"1px solid #6D6D6D","border-radius":"4px"})}},initGallery:function(){var e=localStorage.photoGalleryActiveIndex,i=JSON.parse(localStorage.photoGalleryImgs);localStorage.removeItem("photoGalleryActiveIndex"),localStorage.removeItem("photoGalleryImgs"),t(".gallery").photoGallery({imgs:i,activeIndex:e}),t(".closeWin").click(function(){var e=window.parent||window.top,i=e.document.getElementById("J_pg");t(i).remove()})}})}(jQuery);